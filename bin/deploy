#!/bin/bash
set -o errexit -o pipefail -o xtrace

repo=/home/isucon/isucon9-qualify

cd ${repo}
git reset --hard HEAD
git fetch -p
git checkout origin/${1:-master}

cd ${repo}/webapp/ruby
bundle config set --local without 'development'
bundle install

sudo truncate -s 0 -c /var/log/nginx/access.log
sudo truncate -s 0 -c /var/log/mysql/slow.log

${repo}/mklink

sudo systemctl daemon-reload
sudo systemctl restart mysql.service
sudo systemctl restart nginx.service
sudo systemctl restart isucari.ruby.service
